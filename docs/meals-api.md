# Meals API Documentation

## Overview
The Meals API provides endpoints for managing user meals and meal items with authentication and ownership checks.

## Authentication
All endpoints require a valid JWT token in the Authorization header:
```
Authorization: Bearer <jwt_token>
```

## Base URL
```
/api/meals
```

---

## Endpoints

### GET /api/meals
Get all meals for the authenticated user with optional filtering.

**Query Parameters:**
- `date` (string, optional): Filter by specific date (YYYY-MM-DD)
- `start_date` (string, optional): Filter from start date (YYYY-MM-DD)
- `end_date` (string, optional): Filter to end date (YYYY-MM-DD)
- `limit` (number, optional): Limit results (1-100, default: 20)
- `offset` (number, optional): Skip results (default: 0)

**Response:**
```json
{
  "meals": [
    {
      "id": "uuid",
      "user_id": "uuid",
      "meal_date": "2024-01-15",
      "photo_url": "https://example.com/photo.jpg",
      "source": "manual",
      "notes": "Breakfast",
      "created_at": "2024-01-15T08:00:00Z",
      "updated_at": "2024-01-15T08:00:00Z",
      "total_protein": 25.5,
      "total_carbs": 45.2,
      "total_fat": 12.8,
      "total_calories": 380,
      "item_count": 3,
      "items": []
    }
  ],
  "total": 1,
  "pagination": {
    "limit": 20,
    "offset": 0,
    "has_more": false
  }
}
```

### POST /api/meals
Create a new meal.

**Request Body:**
```json
{
  "meal_date": "2024-01-15",
  "photo_url": "https://example.com/photo.jpg",
  "source": "manual",
  "notes": "Delicious breakfast"
}
```

**Response (201):**
```json
{
  "message": "Meal created successfully",
  "meal": {
    "id": "uuid",
    "user_id": "uuid",
    "meal_date": "2024-01-15",
    "photo_url": "https://example.com/photo.jpg",
    "source": "manual",
    "notes": "Delicious breakfast",
    "created_at": "2024-01-15T08:00:00Z",
    "updated_at": "2024-01-15T08:00:00Z",
    "items": [],
    "total_protein": 0,
    "total_carbs": 0,
    "total_fat": 0,
    "total_calories": 0,
    "item_count": 0
  }
}
```

### GET /api/meals/[id]
Get detailed information about a specific meal, including all meal items.

**Response (200):**
```json
{
  "meal": {
    "id": "uuid",
    "user_id": "uuid",
    "meal_date": "2024-01-15",
    "photo_url": "https://example.com/photo.jpg",
    "source": "manual",
    "notes": "Delicious breakfast",
    "created_at": "2024-01-15T08:00:00Z",
    "updated_at": "2024-01-15T08:00:00Z",
    "total_protein": 25.5,
    "total_carbs": 45.2,
    "total_fat": 12.8,
    "total_calories": 380,
    "item_count": 2,
    "items": [
      {
        "id": "uuid",
        "meal_id": "uuid",
        "name": "Greek Yogurt",
        "quantity": 150,
        "unit": "g",
        "protein": 15,
        "carbs": 10,
        "fat": 5,
        "calories": 140,
        "created_at": "2024-01-15T08:00:00Z",
        "updated_at": "2024-01-15T08:00:00Z"
      }
    ]
  }
}
```

### PATCH /api/meals/[id]
Update a meal's date or notes.

**Request Body:**
```json
{
  "meal_date": "2024-01-16",
  "notes": "Updated notes"
}
```

**Response (200):**
```json
{
  "message": "Meal updated successfully",
  "meal": {
    "id": "uuid",
    "user_id": "uuid",
    "meal_date": "2024-01-16",
    "photo_url": "https://example.com/photo.jpg",
    "source": "manual",
    "notes": "Updated notes",
    "created_at": "2024-01-15T08:00:00Z",
    "updated_at": "2024-01-16T09:00:00Z"
  }
}
```

### DELETE /api/meals/[id]
Delete a meal and all its associated items.

**Response (200):**
```json
{
  "message": "Meal deleted successfully"
}
```

### POST /api/meals/[id]/items
Add items to a meal.

**Request Body (single item):**
```json
{
  "name": "Greek Yogurt",
  "quantity": 150,
  "unit": "g",
  "protein": 15,
  "carbs": 10,
  "fat": 5,
  "calories": 140
}
```

**Request Body (multiple items):**
```json
{
  "items": [
    {
      "name": "Greek Yogurt",
      "quantity": 150,
      "unit": "g",
      "protein": 15,
      "carbs": 10,
      "fat": 5,
      "calories": 140
    },
    {
      "name": "Banana",
      "quantity": 1,
      "unit": "medium",
      "protein": 1,
      "carbs": 25,
      "fat": 0.5,
      "calories": 105
    }
  ]
}
```

**Response (201):**
```json
{
  "message": "2 item(s) added to meal successfully",
  "items": [
    {
      "id": "uuid",
      "meal_id": "uuid",
      "name": "Greek Yogurt",
      "quantity": 150,
      "unit": "g",
      "protein": 15,
      "carbs": 10,
      "fat": 5,
      "calories": 140,
      "created_at": "2024-01-15T08:00:00Z",
      "updated_at": "2024-01-15T08:00:00Z"
    }
  ]
}
```

---

## Data Types

### Source Types
- `manual`: Manually entered by user
- `ai`: Generated by AI analysis
- `scan`: From barcode scanning
- `search`: From food database search

### Validation Rules
- **meal_date**: Must be in YYYY-MM-DD format
- **photo_url**: Must be a valid URL (optional)
- **notes**: Maximum 1000 characters (optional)
- **item names**: 1-255 characters
- **quantities**: Must be positive numbers
- **nutritional values**: Must be non-negative

---

## Error Responses

### 400 Bad Request
```json
{
  "error": "Validation failed: Date must be in YYYY-MM-DD format"
}
```

### 401 Unauthorized
```json
{
  "error": "Authorization token required"
}
```

### 404 Not Found
```json
{
  "error": "Meal not found"
}
```

### 429 Too Many Requests
```json
{
  "error": "Too many requests. Please try again later."
}
```

### 500 Internal Server Error
```json
{
  "error": "Internal server error"
}
```

---

## Example Usage

### Create a meal with items
```bash
# 1. Create meal
curl -X POST /api/meals \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "meal_date": "2024-01-15",
    "source": "manual",
    "notes": "Healthy breakfast"
  }'

# 2. Add items to the meal
curl -X POST /api/meals/<meal-id>/items \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "items": [
      {
        "name": "Greek Yogurt",
        "quantity": 150,
        "unit": "g",
        "protein": 15,
        "carbs": 10,
        "fat": 5,
        "calories": 140
      }
    ]
  }'
```

### Get meals for a specific date
```bash
curl -X GET "/api/meals?date=2024-01-15" \
  -H "Authorization: Bearer <token>"
```